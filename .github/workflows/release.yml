name: Create Release Package

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for the release'
        required: true
        default: 'v1.0.0'

jobs:
  create-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Create release package
      run: |
        # åˆ›å»ºä¸´æ—¶ç›®å½•
        mkdir -p release-temp/emby-ui-plugin
        
        # å¤åˆ¶éœ€è¦çš„æ–‡ä»¶ï¼Œæ’é™¤å¼€å‘ç›¸å…³æ–‡ä»¶
        rsync -av --exclude='.git' \
                  --exclude='.github' \
                  --exclude='.trae' \
                  --exclude='node_modules' \
                  --exclude='*.log' \
                  --exclude='.env*' \
                  --exclude='docker-compose*.yml' \
                  --exclude='Dockerfile*' \
                  --exclude='.gitignore' \
                  --exclude='*.md' \
                  ./ release-temp/emby-ui-plugin/
        
        # åˆ›å»ºtar.gzåŒ…
        cd release-temp
        tar -czf ../emby-ui-plugin.tar.gz emby-ui-plugin/
        cd ..
        
        # éªŒè¯åŒ…å†…å®¹
        echo "Package contents:"
        tar -tzf emby-ui-plugin.tar.gz | head -20
        
        # æ˜¾ç¤ºåŒ…å¤§å°
        ls -lh emby-ui-plugin.tar.gz
    
    - name: Get tag name
      id: get_tag
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "tag_name=${{ github.event.inputs.tag_name }}" >> $GITHUB_OUTPUT
        else
          echo "tag_name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi
    
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.get_tag.outputs.tag_name }}
        release_name: Emby UI Plugin ${{ steps.get_tag.outputs.tag_name }}
        body: |
          ## Emby UI ç¾åŒ–æ’ä»¶ ${{ steps.get_tag.outputs.tag_name }}
          
          ### ğŸ“¦ å®‰è£…æ–¹æ³•
          
          #### æ–¹æ³•ä¸€ï¼šç›´æ¥ä¸‹è½½
          ```bash
          wget https://github.com/zainzzz/emby-ui-plugin/releases/download/${{ steps.get_tag.outputs.tag_name }}/emby-ui-plugin.tar.gz
          tar -xzf emby-ui-plugin.tar.gz
          ```
          
          #### æ–¹æ³•äºŒï¼šDocker é›†æˆ
          ```bash
          # ä¸‹è½½å¹¶è§£å‹
          wget https://github.com/zainzzz/emby-ui-plugin/releases/download/${{ steps.get_tag.outputs.tag_name }}/emby-ui-plugin.tar.gz
          tar -xzf emby-ui-plugin.tar.gz
          
          # å¤åˆ¶åˆ°å®¹å™¨
          docker cp emby-ui-plugin/ your-emby-container:/opt/emby-ui-plugin/
          
          # æ‰§è¡Œå®‰è£…
          docker exec your-emby-container /opt/emby-ui-plugin/scripts/install-plugin.sh
          
          # é‡å¯å®¹å™¨
          docker restart your-emby-container
          ```
          
          ### âœ¨ ä¸»è¦ç‰¹æ€§
          - ğŸ¨ å¤šä¸»é¢˜æ”¯æŒï¼ˆæ·±è‰²ç°ä»£ä¸»é¢˜ã€æµ…è‰²ä¼˜é›…ä¸»é¢˜ï¼‰
          - ğŸ”§ é«˜åº¦å¯å®šåˆ¶åŒ–é…ç½®
          - ğŸ³ Docker å®¹å™¨å®Œç¾é›†æˆ
          - ğŸ“± å“åº”å¼è®¾è®¡ï¼Œæ”¯æŒç§»åŠ¨è®¾å¤‡
          - âš¡ è½»é‡çº§ï¼Œä¸å½±å“ Emby æ€§èƒ½
          
          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          - Emby ç‰ˆæœ¬ï¼š4.7.0+
          - Dockerï¼š20.10+
          - ç°ä»£æµè§ˆå™¨æ”¯æŒ
          
          ---
          
          **å®Œæ•´æ–‡æ¡£**: [README.md](https://github.com/zainzzz/emby-ui-plugin/blob/main/README.md)
        draft: false
        prerelease: false
    
    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./emby-ui-plugin.tar.gz
        asset_name: emby-ui-plugin.tar.gz
        asset_content_type: application/gzip